#!/bin/bash
set -e

echo "Running Puppet Lint"
bundle exec puppet-lint --no-80chars-check --no-140chars-check --fail-on-warnings nubis/puppet/*pp

echo "Running ShellCheck"
find nubis/ -path nubis/travis/vendor -prune -o -type f -print0 | xargs -0 file | grep 'shell script' | cut -d: -f1 | xargs shellcheck

echo "Running JSON Lint"
find nubis/ -path nubis/travis/vendor -prune -o -name '*.json' -print0 | xargs -0 bundle exec jsonlint

if [ -f "nubis/Puppetfile" ]; then
  echo "Installing specified puppet modules"
  ( cd nubis && bundle exec librarian-puppet install )
  echo "Installed puppet modules are:"
  ( cd nubis && bundle exec librarian-puppet show )
  echo "Checking for outdated puppet modules"
  ( cd nubis && bundle exec librarian-puppet outdated )
fi
