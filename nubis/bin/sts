#!/bin/bash

ROLE=$1
shift

if [ "$BUILD_TAG" = "" ]; then
  BUILD_TAG=cli
fi

OUTPUT=`aws sts assume-role --role-arn "$ROLE" --role-session-name "$BUILD_TAG"`

STATUS=$?

if [ "$STATUS" != "0" ]; then
  echo "STS Failure: $OUTPUT"
  exit $STATUS
fi

export AWS_ACCESS_KEY_ID=`echo $OUTPUT | jq -r '.Credentials.AccessKeyId'`
export AWS_SECRET_ACCESS_KEY=`echo $OUTPUT | jq -r '.Credentials.SecretAccessKey'`
export AWS_SECURITY_TOKEN=`echo $OUTPUT | jq -r '.Credentials.SessionToken'`

exec $*
