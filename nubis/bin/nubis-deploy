#!/bin/bash

# Consume user-data
eval `curl -fqs http://169.254.169.254/latest/user-data`

if [ "$ami" = "" ]; then
  ami=`cat artifacts/amis.txt | grep $region | cut -d: -f2`
fi

echo "Deploying AMI $ami into $environment/$region"

CF_TEMPLATE=$WORKSPACE/artifacts/main.json
PLAYBOOK=$WORKSPACE/../ansible.yaml
VARIABLES=$WORKSPACE/../vars.yaml

FULL_STACK_NAME=$stack_name-$environment

if [ -f $CF_TEMPLATE ]; then
echo "Running CloudFormation"
ansible-playbook -i localhost, \
  $PLAYBOOK \
  -e stack_name=$FULL_STACK_NAME \
  -e owner=$owner \
  -e service_name=$service_name \
  -e key_name=$key_name \
  -e region=$region \
  -e env=$environment \
  -e ami=$ami \
  -e template=$CF_TEMPLATE \
  -e @$VARIABLES
fi

echo "Injecting into Consul"
PROJECT_NAME=$service_name NUBIS_ENVIRONMENT=$environment CONSUL_ENDPOINT="public.consul.$environment.$region.$NUBIS_ACCOUNT.$NUBIS_DOMAIN" AWS_DEFAULT_REGION=$region nubis-consul --stack-name $FULL_STACK_NAME get-and-update
